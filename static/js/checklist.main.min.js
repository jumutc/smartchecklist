var GET_SIMPLE_CHECKLIST_ACTION="get_simple_checklist";var GET_DELIMITED_ACTION="get_delimited";Array.prototype.unique=function(){var b=this.concat();for(var d=0;d<b.length;++d){for(var c=d+1;c<b.length;++c){if(b[d]===b[c]){b.splice(c,1)}}}return b};String.prototype.endsWith=function(a){return this.indexOf(a,this.length-a.length)!==-1};jQuery.fn.outerHTML=function(){return jQuery("<div></div>").append(this.clone()).html()};function getURLParameter(a){return decodeURI((RegExp(a+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}function validateEmail(b){var a=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;return a.test(b)}function allSwiped(a){return a.parent().children("li").length==a.parent().children(".item-removed").length}function addSwipe(b,a){b.bind("swipeleft",function(d,e){var c=[];if(localStorage.items_done!=null){c=$.parseJSON(localStorage.items_done)}c.push(b.attr("desk-item"));localStorage.items_done=JSON.stringify(c);b.find("a").addClass("item-removed");b.addClass("item-removed");if(a!=null&&allSwiped(b)){a.trigger("swipeleft")}});b.bind("swiperight",function(d,e){if(localStorage.items_done!=null){var c=$.parseJSON(localStorage.items_done);c.splice(c.indexOf(b.attr("desk-item")),1)}localStorage.items_done=JSON.stringify(c);b.find("a").removeClass("item-removed");b.removeClass("item-removed");if(a!=null){a.trigger("swiperight")}})}function addSwipeDelete(b,a){b.bind("swipeleft",function(e,f){b.remove();a.listview("refresh");if(b.attr("offer_id")!=null){var d=$.parseJSON(localStorage.promoted);d.splice(d.indexOf(b.attr("offer_id")),1);localStorage.promoted=JSON.stringify(d)}else{var c=$.parseJSON(localStorage.checklist_json);c.splice(c.indexOf(b.attr("name")),1);localStorage.checklist_json=JSON.stringify(c)}})}function addSelect(b,a){a.bind("vclick",function(c,d){if(a.find(':contains("Select Category")').length>0){a.find("span span").html("Deselect Category");a.parent().parent().parent().attr("item_selected","true");b.find("span.ui-icon").removeClass("ui-icon-arrow-r").addClass("ui-icon-check");b.attr("item_selected","true")}else{a.find("span span").html("Select Category");a.parent().parent().parent().removeAttr("item_selected");b.find("span.ui-icon").removeClass("ui-icon-check").addClass("ui-icon-arrow-r");b.removeAttr("item_selected")}$("#checklist-items").listview("refresh")})}function initIcon(a,b){b.bind("vclick",function(c,d){if(a.attr("item_selected")=="true"){b.removeClass("ui-icon-check").addClass("ui-icon-plus");a.removeAttr("item_selected")}else{b.removeClass("ui-icon-plus").addClass("ui-icon-check");a.attr("item_selected","true")}$("#checklist-items").listview("refresh")})}function initItem(c,b){var a=$("<li name="+c.split(" ").join("_")+">"+c+"</li>");a.addClass("item-2-large");addSwipeDelete(a,b);return a}function sortChecklist(){$("#checklist-items>li").tsort({order:"desc",attr:"num-children"})}function createCategorized(){$.each($.parseJSON(localStorage.checklist_json),function(b,a){$.each(a,function(){if($("#checklist-items li[name='"+this+"']").length==0){var g=$("<li name='"+this+"' num-children='1' data-filtertext='"+this+" "+b+"'>"+this+"</li>");var e=$('<a href="checklist.html" data-rel="back" data-role="button" data-theme="a">Select Category</a>');var d=$('<a href="checklist.html" data-rel="back" data-role="button">Back</a>');addSelect(g,e);$("#checklist-items").append(g);$("#checklist-items li[name='"+this+"']").append("<ul></ul>");$("#checklist-items li[name='"+this+"'] ul").append(initItem(b,g));$("#checklist-items li[name='"+this+"'] ul").append(e);$("#checklist-items li[name='"+this+"'] ul").append(d)}else{if($("#checklist-items li[name='"+this+"'] ul li[name='"+b+"']").length==0){var c=$("#checklist-items li[name='"+this+"']");c.attr("num-children",c.attr("num-children")+"1");c.attr("data-filtertext",c.attr("data-filtertext")+" "+b);$("#checklist-items li[name='"+this+"'] ul").prepend(initItem(b,c));var f=$("#checklist-items li[name='"+this+"'] ul li").length;if(f>1){c.addClass(f>3?"item-4-large":"item-"+f+"-large")}}}})});sortChecklist()}function createSimple(){$.each($.parseJSON(localStorage.checklist_json),function(a,c){if($("#checklist-items li[name='"+c.split(" ").join("_")+"']").length==0){var b=$('<span class="ui-icon ui-icon-plus ui-icon-shadow"></span>');var d=initItem(c,$("#checklist-items"));d.addClass("ui-btn ui-btn-up-a ui-btn-icon-right ui-li-has-arrow");d.attr("data-iconpos","right");d.attr("data-icon","plus");d.append(b);initIcon(d,b);$("#checklist-items").append(d)}})}function createItems(){if(localStorage.promoted!=null){$("#checklist-items").append(localStorage.promoted);createPromoted("#checklist-items")}if(localStorage.checklist_json!=null){createSimple()}$("#checklist-items").listview("refresh")}function createPromoted(a){$(a+" li").each(function(){var b=$('<span class="ui-icon ui-icon-plus ui-icon-shadow"></span>');$(this).addClass("ui-btn ui-btn-up-a ui-btn-icon-right ui-li-has-arrow");$(this).append(b);initIcon($(this),b);addSwipeDelete($(this),$(a))});$(a).listview("refresh")}function getPlainMessage(a){var b="";$.each($.parseJSON(localStorage.selected_items),function(c,d){b+=d+a;if($('div[data-role="page"]').length>1){$.each($.parseJSON(localStorage.checklist_json),function(f,e){if(e.indexOf(d)!==-1){b+="--"+f+a}})}});return b}function getInvertedJSON(){if($('div[data-role="page"]').length>1){var c=$.parseJSON(localStorage.selected_items);var b=$.parseJSON(localStorage.checklist_json);var a={};$.each(c,function(d,e){a[e]=[];$.each(b,function(g,f){if(f.indexOf(e)!==-1){a[e].push(g)}})});return JSON.stringify(a)}else{return localStorage.selected_items}}function collectSelectedItems(){var a=[];var b=[];$("#checklist-items li[item_selected]").each(function(){if($(this).attr("offer_id")!=null){b.push($(this).attr("offer_id"))}else{a.push($(this).attr("name"))}});localStorage.selected_items=JSON.stringify(a);localStorage.selected_offers=JSON.stringify(b)}function collectPromotedItems(){localStorage.promoted="";$("#promoted-items li[item_selected]").each(function(){$(this).find("span").remove();$(this).removeClass("item-removed");$(this).removeAttr("item_selected");localStorage.promoted+=$(this).outerHTML()})}function executeAndChangePage(c,b){$.mobile.showPageLoadingMsg();b.addClass("ui-btn-active");var a=$('[name="csrfmiddlewaretoken"]').attr("value");$.post(c+".html",{words:$("#words").val(),csrfmiddlewaretoken:a},function(d){if(localStorage.checklist_json!=null){var e=$.parseJSON(localStorage.checklist_json);d=e.concat(d).unique()}localStorage.checklist_json=JSON.stringify(d);$.mobile.changePage("checklist.html");b.removeClass("ui-btn-active")},"json")}function processSimple(a){executeAndChangePage(GET_SIMPLE_CHECKLIST_ACTION,a)}function processDelimited(a){executeAndChangePage(GET_DELIMITED_ACTION,a)}function bindIndexPage(){$(document).bind("pageload",function(a,b){if(b.url.endsWith("login")&&$("#login-errors").length==0){$.mobile.changePage("index.html",{reloadPage:true})}});$(document).bind("pageshow",function(c,d){createItems();if(d.prevPage[0]){var a=d.prevPage[0].getAttribute("id");if(a&&a!="login-page"){var b=a.replace("-page",".html");$("#cancel-btn").attr("href",b)}}$("#recipient").change(function(){if(validateEmail($(this).val())){$("#send_in_person").removeClass("ui-disabled")}else{$("#send_in_person").addClass("ui-disabled")}});$("#advanced-flip").change(function(){if($(this).val()=="on"){$("#simple").css("display","block")}else{$("#simple").css("display","none")}});$("#send-checklist").bind("vclick",function(f,g){collectSelectedItems();var e=$("div[item_selected]");if(e.length>0){e=$("<div></div>");$("div[item_selected]").each(function(){var h=$(this).clone();h.removeClass("ui-body-a");h.removeClass("ui-page");h.css("display","block");h.css("min-height","100px");h.find("ul a").remove();e.append(h)})}else{e=$("#checklist-items").clone();e.empty();$("#checklist-items li[item_selected]").each(function(){e.append($(this).clone())})}localStorage.htmlToSend="<html><head>"+$("head link").outerHTML()+"</head><body>"+e.outerHTML()+"</body></html>"});$("#send_in_person").bind("vclick",function(e,f){$("#send_in_person").attr("href","mailto:"+$("#recipient").val()+"?subject=Your Smartest Checklist&body="+getPlainMessage("%0A"));clearStorage()});$("#send_by_system").bind("vclick",function(f,g){var e=$('[name="csrfmiddlewaretoken"]').attr("value");if(validateEmail($("#recipient").val())){$.post("send_checklist.html",{recipient:$("#recipient").val(),plain_text:getPlainMessage("\n"),plain_html:localStorage.htmlToSend,csrfmiddlewaretoken:e},function(h){alert(h);$.mobile.changePage("index.html")})}else{$.post("create_checklist.html",{recipient:$("#recipient").val(),checklist_json:getInvertedJSON(),offers_json:localStorage.selected_offers,csrfmiddlewaretoken:e},function(h){alert(h);$.mobile.changePage("index.html")})}clearStorage()});$("#select-all").bind("vclick",function(e,f){if($("#select-all").find(':contains("Select All")').length>0){$("#select-all span span").html("Deselect All");$("#checklist-items li").each(function(){$(this).attr("item_selected","true")});$("#checklist-items li span.ui-icon").each(function(){$(this).removeClass("ui-icon-plus").addClass("ui-icon-check")})}else{$("#select-all span span").html("Select All");$("#checklist-items li").each(function(){$(this).removeAttr("item_selected")});$("#checklist-items li span.ui-icon").each(function(){$(this).removeClass("ui-icon-check").addClass("ui-icon-plus")})}});$.each($("[error-id]"),function(){var e=$(this);var f=e.attr("error-id");$("#"+f).css("border-color","red");$("#"+f).focus(function(){e.show()});$("#"+f).blur(function(){e.hide()})});$.mobile.hidePageLoadingMsg()})}function bindPersonalPage(a){$(document).bind("pageshow",function(b,c){$("#send-checklist").addClass("ui-disabled");$("#checklist-done").bind("vclick",function(f,g){localStorage.removeItem("items_done");if($("#checklist-done").attr("href")=="my_desk.html"){var e=$('[name="csrfmiddlewaretoken"]').attr("value");$.post("check_done.html",{checklist_id:getURLParameter("id"),csrfmiddlewaretoken:e})}});$("#checklist-done").attr("href",a);var d=$.parseJSON(localStorage.items_done);$.each($("[desk-item]"),function(){if(d!=null&&d.indexOf($(this).attr("desk-item"))>-1){$(this).addClass("item-removed")}if($(this).attr("parent-desk-item")!=null){addSwipe($(this),$('[desk-item="'+$(this).attr("parent-desk-item")+'"]'))}else{addSwipe($(this),null)}})})}function bindOffersPage(){$(document).bind("pageshow",function(a,b){createPromoted("#promoted-items")})}function clearStorage(){localStorage.removeItem("promoted");localStorage.removeItem("htmlToSend");localStorage.removeItem("selected_items");localStorage.removeItem("selected_offers");localStorage.removeItem("checklist_json")}function initDefaults(){$.mobile.defaultPageTransition="flip"};